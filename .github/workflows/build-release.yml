name: Build Release

on:
    push:
        tags:
            - 'v*'
jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Cache Gradle
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            - name: Set up JDK
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: 17

            - name: Install Android SDK
              uses: android-actions/setup-android@v3

            - name: Install NDK 21.4.7075529
              run: sdkmanager "ndk;21.4.7075529"

            - name: Free disk space
              run: |
                  sudo rm -rf /usr/share/dotnet
                  sudo rm -rf /usr/local/lib/android
                  sudo rm -rf /opt/ghc
                  sudo docker system prune -af

            - name: Make gradlew executable
              run: chmod +x ./gradlew

            - name: Update version
              run: |
                  VERSION_NAME="${GITHUB_REF#refs/tags/}"
                  sed -i "s/APP_VERSION_NAME=.*/APP_VERSION_NAME=${VERSION_NAME}/" gradle.properties

                  OLD_CODE=$(grep APP_VERSION_CODE gradle.properties | cut -d'=' -f2)
                  NEW_CODE=$((OLD_CODE + 1))
                  sed -i "s/APP_VERSION_CODE=.*/APP_VERSION_CODE=${NEW_CODE}/" gradle.properties

            - name: Build Release APK
              run: ./gradlew assembleRelease

            - name: Find APK
              id: apk
              run: |
                  APK_PATH=$(find . -name "*release*.apk" | head -n 1)
                  echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  files: ${{ steps.apk.outputs.APK_PATH }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
